<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Estaci贸n Ambiental</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>Datos de la estaci贸n</h1>

<table border="1" id="tabla">
  <tr>
    <th>Fecha</th>
    <th>Temperatura</th>
    <th>Humedad</th>
    <th>Presi贸n</th>
  </tr>
</table>

<br>

<canvas id="grafico"></canvas>

<script>
  let miGrafico;
let ultimoTimestamp = null;

async function cargarInicial() {

  const res = await fetch(URL);
  const data = await res.json();

  const labels = [];
  const temp = [];
  const hum = [];
  const pres = [];

  data.forEach(d => {
    labels.push(new Date(d.timestamp).toLocaleString());
    temp.push(d.v1);
    hum.push(d.v2);
    pres.push(d.v3);
  });

  ultimoTimestamp = data[data.length - 1].timestamp;

  miGrafico = new Chart(document.getElementById("grafico"), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'Temperatura', data: temp },
        { label: 'Humedad', data: hum },
        { label: 'Presi贸n', data: pres }
      ]
    }
  });
}

async function verificarNuevoDato() {

  const res = await fetch(URL + "?last=true");
  const nuevo = await res.json();

  if (nuevo.timestamp !== ultimoTimestamp) {

    ultimoTimestamp = nuevo.timestamp;

    miGrafico.data.labels.push(
      new Date(nuevo.timestamp).toLocaleString()
    );

    miGrafico.data.datasets[0].data.push(nuevo.v1);
    miGrafico.data.datasets[1].data.push(nuevo.v2);
    miGrafico.data.datasets[2].data.push(nuevo.v3);

    miGrafico.update();
  }
}

cargarInicial();
setInterval(verificarNuevoDato, 30000);

</script>

</body>
</html>

