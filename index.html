<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Monitoreo Ambiental</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        margin: 0;
        font-family: "Segoe UI", Roboto, Arial, sans-serif;
        background-color: #f2f4f8;
        color: #2c3e50;
    }

    header {
        background-color: #1b3a57;
        color: white;
        padding: 25px;
        text-align: center;
    }

    header h1 {
        margin: 0;
        font-weight: 600;
        font-size: 24px;
        letter-spacing: 1px;
    }

    header p {
        margin-top: 8px;
        font-size: 14px;
        opacity: 0.85;
    }

    .contenedor {
        max-width: 1100px;
        margin: 40px auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 40px;
    }

    .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.05);
        padding: 25px;
    }

    .card h2 {
        margin-top: 0;
        font-size: 18px;
        border-bottom: 2px solid #e6ecf2;
        padding-bottom: 10px;
        margin-bottom: 20px;
        color: #1b3a57;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    th {
        background-color: #1b3a57;
        color: white;
        padding: 10px;
        text-align: center;
    }

    td {
        padding: 10px;
        text-align: center;
        border-bottom: 1px solid #e6ecf2;
    }

    tr:nth-child(even) {
        background-color: #f9fbfd;
    }

    .estado {
        text-align: right;
        font-size: 13px;
        margin-top: 10px;
        color: #27ae60;
    }

    canvas {
        max-height: 400px;
    }

    footer {
        text-align: center;
        padding: 20px;
        font-size: 13px;
        color: #7f8c8d;
    }

</style>
</head>

<body>

<header>
    <h1>Sistema de Monitoreo Ambiental en Tiempo Real</h1>
    <p>Estación automática de registro climático</p>
</header>

<div class="contenedor">

    <div class="card">
        <h2>Registro Histórico Reciente</h2>
        <table id="tabla">
            <tr>
                <th>Fecha y Hora</th>
                <th>Temperatura (°C)</th>
                <th>Humedad (%)</th>
                <th>Presión (hPa)</th>
            </tr>
        </table>
        <div class="estado" id="estado">● Sistema activo</div>
    </div>

    <div class="card">
        <h2>Tendencia de Variables Ambientales</h2>
        <canvas id="grafico"></canvas>
    </div>

</div>

<footer>
    Proyecto de Monitoreo Ambiental — Prototipo de Implementación Institucional
</footer>

<script>
const URL = "https://script.google.com/macros/s/AKfycbzRFCU9xvuNrxeL6GIg06jKVhpBFrddmZ86M-T9jXEabJNdHazOXlA-a9FExJ3CABCF5A/exec";

let miGrafico;
let ultimoTimestamp = null;

async function cargarInicial() {

  const res = await fetch(URL);
  const data = await res.json();

  const labels = [];
  const temp = [];
  const hum = [];
  const pres = [];

  const tabla = document.getElementById("tabla");
  tabla.innerHTML = `
    <tr>
      <th>Fecha y Hora</th>
      <th>Temperatura (°C)</th>
      <th>Humedad (%)</th>
      <th>Presión (hPa)</th>
    </tr>
  `;

  data.forEach(d => {

    const fechaFormateada = new Date(d.timestamp).toLocaleString();

    labels.push(fechaFormateada);
    temp.push(d.v1);
    hum.push(d.v2);
    pres.push(d.v3);

    tabla.innerHTML += `
      <tr>
        <td>${fechaFormateada}</td>
        <td>${d.v1}</td>
        <td>${d.v2}</td>
        <td>${d.v3}</td>
      </tr>
    `;
  });

  ultimoTimestamp = data[data.length - 1].timestamp;

  miGrafico = new Chart(document.getElementById("grafico"), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'Temperatura (°C)', data: temp, tension: 0.3 },
        { label: 'Humedad (%)', data: hum, tension: 0.3 },
        { label: 'Presión (hPa)', data: pres, tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });
}

async function verificarNuevoDato() {

  const res = await fetch(URL + "?last=true");
  const nuevo = await res.json();

  if (nuevo.timestamp !== ultimoTimestamp) {

    ultimoTimestamp = nuevo.timestamp;

    const fechaFormateada = new Date(nuevo.timestamp).toLocaleString();

    miGrafico.data.labels.push(fechaFormateada);
    miGrafico.data.datasets[0].data.push(nuevo.v1);
    miGrafico.data.datasets[1].data.push(nuevo.v2);
    miGrafico.data.datasets[2].data.push(nuevo.v3);
    miGrafico.update();

    const tabla = document.getElementById("tabla");
    tabla.innerHTML += `
      <tr>
        <td>${fechaFormateada}</td>
        <td>${nuevo.v1}</td>
        <td>${nuevo.v2}</td>
        <td>${nuevo.v3}</td>
      </tr>
    `;
  }
}

cargarInicial();
setInterval(verificarNuevoDato, 3000);
</script>

</body>
</html>







