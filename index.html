<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Estación Ambiental</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h1>Datos de la estación</h1>

<table border="1" id="tabla">
  <tr>
    <th>Fecha</th>
    <th>Temperatura</th>
    <th>Humedad</th>
    <th>Presión</th>
  </tr>
</table>

<br>

<canvas id="grafico"></canvas>

<script>
  const URL = "https://script.google.com/macros/s/AKfycbzRFCU9xvuNrxeL6GIg06jKVhpBFrddmZ86M-T9jXEabJNdHazOXlA-a9FExJ3CABCF5A/exec";

let miGrafico;
let ultimoTimestamp = null;

async function cargarInicial() {

  const res = await fetch(URL);
  const data = await res.json();

  const labels = [];
  const temp = [];
  const hum = [];
  const pres = [];

  const tabla = document.getElementById("tabla");
  tabla.innerHTML = `
    <tr>
      <th>Fecha</th>
      <th>Temperatura</th>
      <th>Humedad</th>
      <th>Presión</th>
    </tr>
  `;

  data.forEach(d => {

    const fechaFormateada = new Date(d.timestamp).toLocaleString();

    labels.push(fechaFormateada);
    temp.push(d.v1);
    hum.push(d.v2);
    pres.push(d.v3);

    tabla.innerHTML += `
      <tr>
        <td>${fechaFormateada}</td>
        <td>${d.v1}</td>
        <td>${d.v2}</td>
        <td>${d.v3}</td>
      </tr>
    `;
  });

  ultimoTimestamp = data[data.length - 1].timestamp;

  miGrafico = new Chart(document.getElementById("grafico"), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'Temperatura', data: temp },
        { label: 'Humedad', data: hum },
        { label: 'Presión', data: pres }
      ]
    }
  });
}

async function verificarNuevoDato() {

  const res = await fetch(URL + "?last=true");
  const nuevo = await res.json();

  if (nuevo.timestamp !== ultimoTimestamp) {

    ultimoTimestamp = nuevo.timestamp;

    const fechaFormateada = new Date(nuevo.timestamp).toLocaleString();

    // Agregar al gráfico
    miGrafico.data.labels.push(fechaFormateada);
    miGrafico.data.datasets[0].data.push(nuevo.v1);
    miGrafico.data.datasets[1].data.push(nuevo.v2);
    miGrafico.data.datasets[2].data.push(nuevo.v3);
    miGrafico.update();

    // Agregar SOLO una fila nueva a la tabla
    const tabla = document.getElementById("tabla");
    tabla.innerHTML += `
      <tr>
        <td>${fechaFormateada}</td>
        <td>${nuevo.v1}</td>
        <td>${nuevo.v2}</td>
        <td>${nuevo.v3}</td>
      </tr>
    `;
  }
}

cargarInicial();
setInterval(verificarNuevoDato, 1000);

</script>

</body>
</html>





